steps:
  # 1ë‹¨ê³„: dags í´ë” ë™ê¸°í™” (ë³€ê²½ ì—†ìŒ)
  - name: 'gcr.io/cloud-builders/gsutil'
    args: ['-m', 'rsync', '-r', '-d', 'dags', 'gs://asia-northeast3-tu-main-dat-d8e0bfa9-bucket/dags']

  # 2ë‹¨ê³„: [ìˆ˜ì •ë¨] requirements.txt íŒŒì¼ ë¹„êµ í›„, ë³€ê²½ëì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:478.0.0'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # gsutil diff: ë‘ íŒŒì¼ì´ ë‹¤ë¥´ë©´ 0ì´ ì•„ë‹Œ ì¢…ë£Œ ì½”ë“œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        # '|| true'ëŠ” GCSì— íŒŒì¼ì´ ì•„ì§ ì—†ì„ ë•Œ ì˜¤ë¥˜ë¡œ ì¢…ë£Œë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
        if gsutil diff -s requirements.txt gs://asia-northeast3-tu-main-dat-d8e0bfa9-bucket/requirements.txt >/dev/null 2>&1; then
          echo "âœ… requirements.txtì— ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
        else
          echo "ğŸ”„ requirements.txtê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  í™˜ê²½ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
          
          # 1. ìƒˆ requirements.txt íŒŒì¼ ì—…ë¡œë“œ
          gsutil cp requirements.txt gs://asia-northeast3-tu-main-dat-d8e0bfa9-bucket/requirements.txt
          
          # 2. Composer í™˜ê²½ ì—…ë°ì´íŠ¸ ì‹¤í–‰
          gcloud composer environments update tu-main-data-airflow-v1 \
            --location asia-northeast3 \
            --update-pypi-packages-from-file gs://asia-northeast3-tu-main-dat-d8e0bfa9-bucket/requirements.txt
        fi
options:
  logging: CLOUD_LOGGING_ONLY